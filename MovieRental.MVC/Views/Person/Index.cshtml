@model PersonListViewModel

@{
    ViewData["Title"] = @localizer.GetValue("PopularPeople");
}

<div class="container">
    <div class="d-sm-flex align-items-center justify-content-between mt-5 mb-3 overflow-hidden">
        <h1 class="h5 mb-0 float-left">@localizer.GetValue("PopularPeople")</h1>
        <div class="btn-group float-right">
            <button type="button" class="d-sm-inline-block btn btn-sm btn-primary shadow-sm dropdown-toggle"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                @localizer.GetValue("SortBy") &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            </button>
            <div class="dropdown-menu dropdown-menu-right">
                <a class="dropdown-item" href="?sortBy=ListOrder">@localizer.GetValue("ListOrder")</a>
                <a class="dropdown-item" href="?sortBy=DateAdded">@localizer.GetValue("DateAdded")</a>
            </div>
        </div>
    </div>

    <!-- Content Row -->
    <div class="row">
        <div class="col-xl-12 col-lg-12">
            <div class="row list-bp" id="people-container">
                @await Html.PartialAsync("_PeopleCardPartial", Model.People)
            </div>

            <!-- Loading Spinner -->
            <div class="text-center mt-4 mb-5 col-12" id="loading-spinner" style="display: none;">
                <div class="spinner-border" role="status">
                    <span class="sr-only">@localizer.GetValue("Loading")</span>
                </div>
            </div>

            <div class="text-center mt-4 mb-5 col-12" id="no-more-data" style="display: none;">
                <p class="text-muted">@localizer.GetValue("NoMorePeople")</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentPage = @Model.CurrentPage;
        let totalPages = @Model.TotalPages;
        let isLoading = false;
        let filterByType = '@Model.FilterByType';
        let searchQuery = '@Model.SearchQuery';
        let sortBy = '@Model.SortBy';

        $(window).scroll(function() {
            if ($(window).scrollTop() + $(window).height() >= $(document).height() - 500) {
                if (!isLoading && currentPage < totalPages) {
                    loadMorePeople();
                }
            }
        });

        function loadMorePeople() {
            isLoading = true;
            $('#loading-spinner').show();

            currentPage++;

            $.ajax({
                url: '@Url.Action("LoadMore", "Person")',
                type: 'GET',
                data: {
                    filterByType: filterByType || null,
                    searchQuery: searchQuery || null,
                    sortBy: sortBy || null,
                    page: currentPage,
                    pageSize: @Model.PageSize
                },
                success: function(data) {
                    if (data && data.trim().length > 0) {
                        $('#people-container').append(data);
                        isLoading = false;
                        $('#loading-spinner').hide();

                        if (currentPage >= totalPages) {
                            $('#no-more-data').show();
                        }
                    } else {
                        $('#loading-spinner').hide();
                        $('#no-more-data').show();
                    }
                },
                error: function() {
                    isLoading = false;
                    $('#loading-spinner').hide();
                    alert('@localizer.GetValue("ErrorLoadingData")');
                }
            });
        }
    </script>
}