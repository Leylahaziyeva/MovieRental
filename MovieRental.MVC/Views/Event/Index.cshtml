@model EventFilterResultViewModel

<div class="container">
    <div class="d-sm-flex align-items-center justify-content-between mt-5 mb-3 overflow-hidden">
        <h1 class="h5 mb-0 float-left">@localizer.GetValue("Events")</h1>
        <a asp-action="Index" class="float-right d-sm-inline-block btn btn-sm btn-primary shadow-sm-sm">
            @localizer.GetValue("ResetFilters") <i class="fas fa-times fa-sm text-white-50"></i>
        </a>
    </div>

    <div class="row">
        <!-- Filters Sidebar -->
        <div class="col-xl-3 col-lg-4">
            <!-- Mobile Filters -->
            <div class="filters mobile-filters shadow-sm rounded bg-white mb-4 d-none d-block d-md-none">
                <div class="border-bottom">
                    <a class="h6 font-weight-bold text-dark d-block m-0 p-3" data-toggle="collapse" href="#mobile-filters" role="button" aria-expanded="false" aria-controls="mobile-filters">
                        @localizer.GetValue("FilterBy") <i class="fas fa-angle-down float-right mt-1"></i>
                    </a>
                </div>
                <div id="mobile-filters" class="filters-body collapse multi-collapse">
                    <div id="accordion">
                        <form asp-action="Index" method="get" id="mobileFilterForm">
                            <!-- Search -->
                            <div class="filters-card border-bottom p-3">
                                <div class="filters-card-header" id="headingSearchMobile">
                                    <h6 class="mb-0">
                                        <a href="#" class="btn-link" data-toggle="collapse" data-target="#collapseSearchMobile" aria-expanded="true" aria-controls="collapseSearchMobile">
                                            @localizer.GetValue("Search") <i class="fas fa-angle-down float-right"></i>
                                        </a>
                                    </h6>
                                </div>
                                <div id="collapseSearchMobile" class="collapse" aria-labelledby="headingSearchMobile" data-parent="#accordion">
                                    <div class="filters-card-body card-shop-filters">
                                        <input type="text" name="SearchQuery" value="@Model.Filter.SearchQuery"
                                               class="form-control" placeholder="@localizer.GetValue("SearchEvents")">
                                    </div>
                                </div>
                            </div>

                            <!-- Category -->
                            <div class="filters-card border-bottom p-3">
                                <div class="filters-card-header" id="headingGenreMobile">
                                    <h6 class="mb-0">
                                        <a href="#" class="btn-link" data-toggle="collapse" data-target="#collapseGenreMobile" aria-expanded="true" aria-controls="collapseGenreMobile">
                                            @localizer.GetValue("Category") <i class="fas fa-angle-down float-right"></i>
                                        </a>
                                    </h6>
                                </div>
                                <div id="collapseGenreMobile" class="collapse" aria-labelledby="headingGenreMobile" data-parent="#accordion">
                                    <div class="filters-card-body card-shop-filters">
                                        <input type="text" name="Category" value="@Model.Filter.Category"
                                               class="form-control" placeholder="@localizer.GetValue("SearchCategory")">
                                    </div>
                                </div>
                            </div>

                            <!-- Location -->
                            <div class="filters-card border-bottom p-3">
                                <div class="filters-card-header" id="headingLocationMobile">
                                    <h6 class="mb-0">
                                        <a href="#" class="btn-link" data-toggle="collapse" data-target="#collapseLocationMobile" aria-expanded="true" aria-controls="collapseLocationMobile">
                                            @localizer.GetValue("Location") <i class="fas fa-angle-down float-right"></i>
                                        </a>
                                    </h6>
                                </div>
                                <div id="collapseLocationMobile" class="collapse" aria-labelledby="headingLocationMobile" data-parent="#accordion">
                                    <div class="filters-card-body card-shop-filters">
                                        <input type="text" name="Location" value="@Model.Filter.Location"
                                               class="form-control" placeholder="@localizer.GetValue("EnterLocation")">
                                    </div>
                                </div>
                            </div>

                            <!-- Date Range -->
                            <div class="filters-card border-bottom p-3">
                                <div class="filters-card-header" id="headingDateMobile">
                                    <h6 class="mb-0">
                                        <a href="#" class="btn-link" data-toggle="collapse" data-target="#collapseDateMobile" aria-expanded="true" aria-controls="collapseDateMobile">
                                            @localizer.GetValue("DateRange") <i class="fas fa-angle-down float-right"></i>
                                        </a>
                                    </h6>
                                </div>
                                <div id="collapseDateMobile" class="collapse" aria-labelledby="headingDateMobile" data-parent="#accordion">
                                    <div class="filters-card-body card-shop-filters">
                                        <div class="mb-2">
                                            <label class="small">@localizer.GetValue("From")</label>
                                            <input type="date" name="FromDate" value="@Model.Filter.FromDate?.ToString("yyyy-MM-dd")" class="form-control form-control-sm">
                                        </div>
                                        <div>
                                            <label class="small">@localizer.GetValue("To")</label>
                                            <input type="date" name="ToDate" value="@Model.Filter.ToDate?.ToString("yyyy-MM-dd")" class="form-control form-control-sm">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Price -->
                            <div class="filters-card border-bottom p-3">
                                <div class="filters-card-header" id="headingPriceMobile">
                                    <h6 class="mb-0">
                                        <a href="#" class="btn-link" data-toggle="collapse" data-target="#collapsePriceMobile" aria-expanded="true" aria-controls="collapsePriceMobile">
                                            @localizer.GetValue("MaxPrice") <i class="fas fa-angle-down float-right"></i>
                                        </a>
                                    </h6>
                                </div>
                                <div id="collapsePriceMobile" class="collapse" aria-labelledby="headingPriceMobile" data-parent="#accordion">
                                    <div class="filters-card-body card-shop-filters">
                                        <input type="number" name="MaxPrice" value="@Model.Filter.MaxPrice"
                                               class="form-control" placeholder="0.00" step="0.01" min="0">
                                    </div>
                                </div>
                            </div>

                            <div class="p-3">
                                <button type="submit" class="btn btn-primary btn-block">
                                    @localizer.GetValue("ApplyFilters")
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Desktop Filters -->
            <div class="filters shadow-sm rounded bg-white mb-3 d-none d-sm-none d-md-block">
                <div class="filters-header border-bottom p-3">
                    <h6 class="m-0 text-dark">@localizer.GetValue("FilterBy")</h6>
                </div>
                <div class="filters-body">
                    <div id="accordion">
                        <form asp-action="Index" method="get" id="filterForm">
                            <!-- Search Filter -->
                            <div class="filters-card border-bottom p-3">
                                <div class="filters-card-header" id="headingSearch">
                                    <h6 class="mb-0">
                                        <a href="#" class="btn-link" data-toggle="collapse" data-target="#collapseSearch" aria-expanded="true" aria-controls="collapseSearch">
                                            @localizer.GetValue("Search")
                                            <i class="fas fa-angle-down float-right"></i>
                                        </a>
                                    </h6>
                                </div>
                                <div id="collapseSearch" class="collapse show" aria-labelledby="headingSearch" data-parent="#accordion">
                                    <div class="filters-card-body card-shop-filters">
                                        <div class="form-group">
                                            <i class="fas fa-search"></i>
                                            <input type="text" name="SearchQuery" value="@Model.Filter.SearchQuery"
                                                   class="form-control" placeholder="@localizer.GetValue("SearchEvents")">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Category Filter -->
                            <div class="filters-card border-bottom p-3">
                                <div class="filters-card-header" id="headingCategory">
                                    <h6 class="mb-0">
                                        <a href="#" class="btn-link" data-toggle="collapse" data-target="#collapseCategory" aria-expanded="true" aria-controls="collapseCategory">
                                            @localizer.GetValue("Category")
                                            <i class="fas fa-angle-down float-right"></i>
                                        </a>
                                    </h6>
                                </div>
                                <div id="collapseCategory" class="collapse show" aria-labelledby="headingCategory" data-parent="#accordion">
                                    <div class="filters-card-body card-shop-filters">
                                        <div class="form-group">
                                            <i class="fas fa-search"></i>
                                            <input type="text" name="Category" value="@Model.Filter.Category"
                                                   class="form-control" placeholder="@localizer.GetValue("SearchCategory")">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Location Filter -->
                            <div class="filters-card border-bottom p-3">
                                <div class="filters-card-header" id="headingLocation">
                                    <h6 class="mb-0">
                                        <a href="#" class="btn-link" data-toggle="collapse" data-target="#collapseLocation" aria-expanded="true" aria-controls="collapseLocation">
                                            @localizer.GetValue("Location")
                                            <i class="fas fa-angle-down float-right"></i>
                                        </a>
                                    </h6>
                                </div>
                                <div id="collapseLocation" class="collapse show" aria-labelledby="headingLocation" data-parent="#accordion">
                                    <div class="filters-card-body card-shop-filters">
                                        <input type="text" name="Location" value="@Model.Filter.Location"
                                               class="form-control" placeholder="@localizer.GetValue("EnterLocation")">
                                    </div>
                                </div>
                            </div>

                            <!-- Date Range Filter -->
                            <div class="filters-card border-bottom p-3">
                                <div class="filters-card-header" id="headingDateRange">
                                    <h6 class="mb-0">
                                        <a href="#" class="btn-link" data-toggle="collapse" data-target="#collapseDateRange" aria-expanded="false" aria-controls="collapseDateRange">
                                            @localizer.GetValue("DateRange")
                                            <i class="fas fa-angle-down float-right"></i>
                                        </a>
                                    </h6>
                                </div>
                                <div id="collapseDateRange" class="collapse" aria-labelledby="headingDateRange" data-parent="#accordion">
                                    <div class="filters-card-body card-shop-filters">
                                        <div class="mb-2">
                                            <label class="small">@localizer.GetValue("From")</label>
                                            <input type="date" name="FromDate" value="@Model.Filter.FromDate?.ToString("yyyy-MM-dd")"
                                                   class="form-control form-control-sm">
                                        </div>
                                        <div>
                                            <label class="small">@localizer.GetValue("To")</label>
                                            <input type="date" name="ToDate" value="@Model.Filter.ToDate?.ToString("yyyy-MM-dd")"
                                                   class="form-control form-control-sm">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Price Filter -->
                            <div class="filters-card border-bottom p-3">
                                <div class="filters-card-header" id="headingPrice">
                                    <h6 class="mb-0">
                                        <a href="#" class="btn-link" data-toggle="collapse" data-target="#collapsePrice" aria-expanded="false" aria-controls="collapsePrice">
                                            @localizer.GetValue("MaxPrice")
                                            <i class="fas fa-angle-down float-right"></i>
                                        </a>
                                    </h6>
                                </div>
                                <div id="collapsePrice" class="collapse" aria-labelledby="headingPrice" data-parent="#accordion">
                                    <div class="filters-card-body card-shop-filters">
                                        <input type="number" name="MaxPrice" value="@Model.Filter.MaxPrice"
                                               class="form-control" placeholder="0.00" step="0.01" min="0">
                                    </div>
                                </div>
                            </div>

                            <div class="p-3">
                                <button type="submit" class="btn btn-primary btn-block">
                                    @localizer.GetValue("ApplyFilters")
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="d-none d-sm-none d-lg-block">
                <img class="img-fluid rounded mt-3" src="https://via.placeholder.com/255x623" alt="Advertisement">
            </div>
        </div>

        <!-- Events List -->
        <div class="col-xl-9 col-lg-8">
            <div class="row list-bp" id="eventsContainer">
                @if (Model.Events != null && Model.Events.Any())
                {
                    <partial name="_EventCardsPartial" model="Model.Events" />
                }
                else
                {
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-calendar-times fa-3x text-muted"></i>
                        <h5 class="text-muted mt-3">@localizer.GetValue("NoEventsFound")</h5>
                    </div>
                }
            </div>

            <!-- Loading Spinner -->
            <div class="text-center mt-4 mb-5" id="loadingSpinner" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">@localizer.GetValue("Loading")</span>
                </div>
            </div>

            <!-- End Message -->
            <div class="text-center mt-4 mb-5" id="endMessage" style="display: none;">
                <p class="text-muted">@localizer.GetValue("NoMoreEvents")</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentPage = @Model.Filter.Page;
        let isLoading = false;
        let hasMorePages = @Model.HasNextPage.ToString().ToLower();

        $(window).scroll(function() {
            if (isLoading || !hasMorePages) return;

            if ($(window).scrollTop() + $(window).height() > $(document).height() - 500) {
                loadMoreEvents();
            }
        });

        function loadMoreEvents() {
            if (isLoading || !hasMorePages) return;

            isLoading = true;
            currentPage++;

            $('#loadingSpinner').show();

            $.ajax({
                url: '@Url.Action("LoadMoreEvents")',
                type: 'GET',
                data: {
                    page: currentPage,
                    pageSize: @Model.Filter.PageSize,
                    searchQuery: '@Model.Filter.SearchQuery',
                    location: '@Model.Filter.Location',
                    category: '@Model.Filter.Category',
                    fromDate: '@Model.Filter.FromDate?.ToString("yyyy-MM-dd")',
                    toDate: '@Model.Filter.ToDate?.ToString("yyyy-MM-dd")',
                    maxPrice: '@Model.Filter.MaxPrice'
                },
                success: function(data) {
                    if (data.trim() === '') {
                        hasMorePages = false;
                        $('#endMessage').show();
                    } else {
                        $('#eventsContainer').append(data);
                    }

                    $('#loadingSpinner').hide();
                    isLoading = false;
                },
                error: function() {
                    $('#loadingSpinner').hide();
                    isLoading = false;
                    alert('@localizer.GetValue("ErrorLoadingEvents")');
                }
            });
        }
    </script>
}