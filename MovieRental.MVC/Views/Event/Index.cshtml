@model EventFilterResultViewModel


@* @{
    ViewBag.FilterType = "Event";
    ViewBag.ActionName = "Index";
}
 *@
<div class="container">
    <div class="d-sm-flex align-items-center justify-content-between mt-5 mb-3 overflow-hidden">
        <h1 class="h5 mb-0 float-left">@localizer.GetValue("Events")</h1>
        <a asp-action="Index" class="float-right d-sm-inline-block btn btn-sm btn-primary shadow-sm-sm">
            @localizer.GetValue("ResetFilters") <i class="fas fa-times fa-sm text-white-50"></i>
        </a>
    </div>

    <div class="row">
        <!-- Filters Sidebar -->
        <div class="col-xl-3 col-lg-4">
            <!-- Mobile Filters -->
            <div class="filters mobile-filters shadow-sm rounded bg-white mb-4 d-none d-block d-md-none">
                <div class="border-bottom">
                    <a class="h6 font-weight-bold text-dark d-block m-0 p-3" data-toggle="collapse" href="#mobile-filters" role="button" aria-expanded="false" aria-controls="mobile-filters">
                        @localizer.GetValue("FilterBy") <i class="fas fa-angle-down float-right mt-1"></i>
                    </a>
                </div>
                <div id="mobile-filters" class="filters-body collapse multi-collapse">
                    <partial name="_FiltersPartial" model="Model.Filter" />
                </div>
            </div>

            <!-- Desktop Filters -->
            <div class="filters shadow-sm rounded bg-white mb-3 d-none d-sm-none d-md-block">
                <div class="filters-header border-bottom p-3">
                    <h6 class="m-0 text-dark">@localizer.GetValue("FilterBy")</h6>
                </div>
                <div class="filters-body">
                    <partial name="_FiltersPartial" model="Model.Filter" />
                </div>
            </div>
        </div>

        <!-- Events List -->
        <div class="col-xl-9 col-lg-8">
            <div class="row list-bp" id="eventsContainer">
                @if (Model.Events != null && Model.Events.Any())
                {
                    <partial name="_EventCardsPartial" model="Model.Events" />
                }
                else
                {
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-calendar-times fa-3x text-muted"></i>
                        <h5 class="text-muted mt-3">@localizer.GetValue("NoEventsFound")</h5>
                    </div>
                }
            </div>

            <!-- Loading Spinner -->
            <div class="text-center mt-4 mb-5" id="loadingSpinner" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">@localizer.GetValue("Loading")</span>
                </div>
            </div>

            <!-- End Message -->
            <div class="text-center mt-4 mb-5" id="endMessage" style="display: none;">
                <p class="text-muted">@localizer.GetValue("NoMoreEvents")</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentPage = @Model.Filter.Page;
        let isLoading = false;
        let hasMorePages = @Model.HasNextPage.ToString().ToLower();

        $(window).scroll(function() {
            if (isLoading || !hasMorePages) return;

            if ($(window).scrollTop() + $(window).height() > $(document).height() - 500) {
                loadMoreEvents();
            }
        });

        function loadMoreEvents() {
            if (isLoading || !hasMorePages) return;

            isLoading = true;
            currentPage++;

            $('#loadingSpinner').show();

            $.ajax({
                url: '@Url.Action("LoadMoreEvents")',
                type: 'GET',
                data: {
                    page: currentPage,
                    pageSize: @Model.Filter.PageSize,
                    searchQuery: '@Model.Filter.SearchQuery',
                    locationId: '@Model.Filter.LocationId',
                    eventCategoryId: '@Model.Filter.EventCategoryId',
                    fromDate: '@Model.Filter.FromDate?.ToString("yyyy-MM-dd")',
                    toDate: '@Model.Filter.ToDate?.ToString("yyyy-MM-dd")',
                    maxPrice: '@Model.Filter.MaxPrice',
                    currentLanguageId: '@Model.Filter.CurrentLanguageId'
                },
                success: function(data) {
                    if (data.trim() === '') {
                        hasMorePages = false;
                        $('#endMessage').show();
                    } else {
                        $('#eventsContainer').append(data);
                    }

                    $('#loadingSpinner').hide();
                    isLoading = false;
                },
                error: function() {
                    $('#loadingSpinner').hide();
                    isLoading = false;
                    alert('@localizer.GetValue("ErrorLoadingEvents")');
                }
            });
        }
    </script>
}