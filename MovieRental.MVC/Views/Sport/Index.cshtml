@model IEnumerable<SportViewModel>

@{
    ViewData["Title"] = localizer.GetValue("Sports");
    var filter = ViewBag.Filter as SportFilterViewModel ?? new SportFilterViewModel();
}

<div class="container">
    <div class="d-sm-flex align-items-center justify-content-between mt-5 mb-3 overflow-hidden">
        <h1 class="h5 mb-0 float-left">@localizer.GetValue("Sports")</h1>
        <a asp-action="Index" class="float-right d-sm-inline-block btn btn-sm btn-primary shadow-sm-sm">
            @localizer.GetValue("ResetFilters") <i class="fas fa-times fa-sm text-white-50"></i>
        </a>
    </div>

    <div class="row">
        <!-- Filters Sidebar -->
        <div class="col-xl-3 col-lg-4">
            <!-- Mobile Filters -->
            <div class="filters mobile-filters shadow-sm rounded bg-white mb-4 d-none d-block d-md-none">
                <div class="border-bottom">
                    <a class="h6 font-weight-bold text-dark d-block m-0 p-3" data-toggle="collapse"
                       href="#mobile-filters" role="button" aria-expanded="false" aria-controls="mobile-filters">
                        @localizer.GetValue("FilterBy") <i class="fas fa-angle-down float-right mt-1"></i>
                    </a>
                </div>
                <div id="mobile-filters" class="filters-body collapse multi-collapse">
                    @await Html.PartialAsync("_FiltersPartial", filter)
                </div>
            </div>

            <!-- Desktop Filters -->
            <div class="filters shadow-sm rounded bg-white mb-3 d-none d-sm-none d-md-block">
                <div class="filters-header border-bottom p-3">
                    <h6 class="m-0 text-dark">@localizer.GetValue("FilterBy")</h6>
                </div>
                <div class="filters-body">
                    @await Html.PartialAsync("_FiltersPartial", filter)
                </div>
            </div>
        </div>

        <!-- Sports List -->
        <div class="col-xl-9 col-lg-8">
            <div class="row list-bp" id="sportsContainer">
                @if (Model != null && Model.Any())
                {
                    <partial name="_SportCardsPartial" model="Model" />
                }
                else
                {
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-info-circle fa-3x text-muted"></i>
                        <h5 class="text-muted mt-3">@localizer.GetValue("NoSportsFound")</h5>
                    </div>
                }
            </div>

            <!-- Loading Spinner -->
            <div class="text-center mt-4 mb-5" id="loadingSpinner" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">@localizer.GetValue("Loading")</span>
                </div>
            </div>

            <!-- End Message -->
            <div class="text-center mt-4 mb-5" id="endMessage" style="display: none;">
                <p class="text-muted">@localizer.GetValue("NoMoreSports")</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentPage = 1;
        let isLoading = false;
        let hasMorePages = true;
        const pageSize = 12;

        $(window).scroll(function() {
            if (isLoading || !hasMorePages) return;

            if ($(window).scrollTop() + $(window).height() > $(document).height() - 500) {
                loadMoreSports();
            }
        });

        function loadMoreSports() {
            if (isLoading || !hasMorePages) return;

            isLoading = true;
            currentPage++;

            $('#loadingSpinner').show();

            var sportTypeIds = $('input[name="SportTypeIds"]:checked').map(function() {
                return $(this).val();
            }).get();

            var locationIds = $('input[name="LocationIds"]:checked').map(function() {
                return $(this).val();
            }).get();

            $.ajax({
                url: '@Url.Action("LoadMoreSports")',
                type: 'GET',
                traditional: true,
                data: {
                    page: currentPage,
                    pageSize: pageSize,
                    sportTypeIds: sportTypeIds,
                    locationIds: locationIds
                },
                success: function(data) {
                    if (data.trim() === '') {
                        hasMorePages = false;
                        $('#endMessage').show();
                    } else {
                        $('#sportsContainer').append(data);
                    }

                    $('#loadingSpinner').hide();
                    isLoading = false;
                },
                error: function() {
                    $('#loadingSpinner').hide();
                    isLoading = false;
                    alert('@localizer.GetValue("ErrorLoadingSports")');
                }
            });
        }
    </script>
}