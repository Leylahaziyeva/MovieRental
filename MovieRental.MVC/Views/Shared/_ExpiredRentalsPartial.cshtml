@model List<MovieRental.BLL.ViewModels.Rental.RentalViewModel>

@if (Model == null || !Model.Any())
{
    <div class="col-12 text-center py-4">
        <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
        <p class="text-muted small">@localizer.GetValue("NoPastRentals")</p>
    </div>
}
else
{
    foreach (var rental in Model)
    {
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card m-card shadow-sm border-0" style="opacity: 0.8;">
                <a href="/Movie/Details/@rental.MovieId">
                    <div class="m-card-cover position-relative">
                        <!-- Expired Badge -->
                        <div class="position-absolute" style="top: 10px; right: 10px; z-index: 10;">
                            <span class="badge badge-secondary px-2 py-1">
                                <i class="fas fa-clock mr-1"></i> @localizer.GetValue("Expired")
                            </span>
                        </div>

                        <!-- Watched Badge -->
                        @if (rental.HasWatched)
                        {
                            <div class="position-absolute" style="top: 10px; left: 10px; z-index: 10;">
                                <span class="badge badge-info px-2 py-1">
                                    <i class="fas fa-eye mr-1"></i> @localizer.GetValue("Watched")
                                </span>
                            </div>
                        }

                        <!-- Grayscale overlay for expired -->
                        <div style="filter: grayscale(50%);">
                            <img src="@rental.MoviePosterUrl" class="card-img-top" alt="@rental.MovieTitle">
                        </div>
                    </div>

                    <div class="card-body p-3">
                        <h6 class="card-title text-white mb-1">@rental.MovieTitle</h6>
                        <p class="card-text mb-2">
                            <small class="text-muted">
                                <i class="fas fa-calendar mr-1"></i>
                                Rented: @rental.RentalDate.ToString("MMM dd, yyyy")
                            </small>
                        </p>
                        <p class="card-text mb-2">
                            <small class="text-muted">
                                <i class="fas fa-calendar-times mr-1"></i>
                                Expired: @rental.ExpiryDate.ToString("MMM dd, yyyy")
                            </small>
                        </p>

                        @if (rental.HasWatched)
                        {
                            <p class="card-text">
                                <small class="text-info">
                                    <i class="fas fa-clock mr-1"></i>
                                    Watched: @rental.TotalWatchTimeMinutes min
                                </small>
                            </p>
                        }
                        else
                        {
                            <p class="card-text">
                                <small class="text-warning">
                                    <i class="fas fa-exclamation-circle mr-1"></i>
                                    Not watched
                                </small>
                            </p>
                        }

                        <!-- Rent Again Button -->
                        <div class="mt-3">
                            <button class="btn btn-outline-primary btn-block btn-sm rent-again-btn"
                                    data-movie-id="@rental.MovieId">
                                <i class="fas fa-redo mr-1"></i> @localizer.GetValue("RentAgain")
                            </button>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    }
}

<script>
    $(document).on('click', '.rent-again-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const movieId = $(this).data('movie-id');
        const btn = $(this);

        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-1"></i> Processing...');

        $.ajax({
            url: '/Rental/RentMovie',
            type: 'POST',
            data: {
                movieId: movieId,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function(response) {
                if (response.success) {
                    toastr.success('Movie rented successfully!');
                    // Reload both active and expired rentals
                    loadActiveRentals();
                    loadExpiredRentals();
                } else {
                    toastr.error(response.message);
                    btn.prop('disabled', false).html('<i class="fas fa-redo mr-1"></i> Rent Again');
                }
            },
            error: function() {
                toastr.error('An error occurred');
                btn.prop('disabled', false).html('<i class="fas fa-redo mr-1"></i> Rent Again');
            }
        });
    });
</script>